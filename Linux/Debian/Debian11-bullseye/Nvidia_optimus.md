# NVIDIA Optimus

Laptop Model: Asus ROG zephyrus gu603z <br /> 
OS: Debian 11 <br /> 
Distro: Mx Linux 21.2 <br />
Nvidia Model: GeForce RTX 3060 Mobile
## Installation

### Download driver
First you need to download nvidia driver from `https://www.nvidia.com/en-us/drivers/unix/`. driver version in my case is `520.56.06`

### Install driver

You can read official nvidia docs for installation, but it's too much :) <br />
I used [this docs](https://www.if-not-true-then-false.com/2021/debian-ubuntu-linux-mint-nvidia-guide/)

```bash
# Remove old driver
# Debian and Linux Mint
apt autoremove $(dpkg -l nvidia-driver* |grep ii |awk '{print $2}')
# Ubuntu
apt autoremove $(dpkg -l xserver-xorg-video-nvidia* |grep ii |awk '{print $2}')

# Reboot
reboot

# Install needed dependencies
apt install linux-headers-$(uname -r) build-essential gcc make acpid dkms libglvnd-core-dev libglvnd0 libglvnd-dev dracut 

# Disable nouveau by adding the below lines to the /etc/modprobe.d/blacklist.conf
blacklist nouveau
options nouveau modeset=0

# Reboot to runlevel 3 because in Nvidia installation X11 must be down
systemctl set-default multi-user.target
reboot

# Run NVIDIA Binary
sudo bash NVIDIA-Linux-x86_64-520.56.06.run

# Reboot to graphical mode
systemctl set-default graphical.target
reboot
```

Then you can see the installed driver with the command `inxi -G`, my output showed in the below

```
Graphics:  Device-1: Intel Alder Lake-P Integrated Graphics driver: i915 v: kernel 
           Device-2: NVIDIA GA106M [GeForce RTX 3060 Mobile / Max-Q] driver: nvidia v: 520.56.06 
           Device-3: Quanta USB2.0 HD UVC WebCam type: USB driver: uvcvideo 
           Display: x11 server: X.Org 1.20.14 driver: loaded: modesetting,nvidia resolution: 1: 1920x1080~60Hz 
           2: 2560x1600~60Hz 
           OpenGL: renderer: NVIDIA GeForce RTX 3060 Laptop GPU/PCIe/SSE2 v: 4.6.0 NVIDIA 520.56.06 
```

## Config Xserver

For config Xserver you need to see [this docs](https://wiki.archlinux.org/title/NVIDIA_Optimus)

- Note: If your `xorg.conf` is empty or not created in `/etx/X11`, you can create it with the command `sudo nvidia-xconfig`

- Note: In my case, after installation, the laptop monitor doesn't work and only the HDMI port worked, after many searches on google and Nvidia forums I found the solution by adding this section to `xorg.conf` 

```bash
Section "Module"
    Load "modesetting"
EndSection

Section "Device"
    Identifier     "intel"
    Driver         "modesetting"
    Option         "AccelMethod" "none"
    BusID          "PCI:0:2:0"
EndSection
```

My `xorg.conf` showed in the below: 

```
# nvidia-xconfig: X configuration file generated by nvidia-xconfig
# nvidia-xconfig:  version 520.56.06

Section "Module"
    Load "modesetting"
EndSection

Section "ServerLayout"
    Identifier     "Layout0"
    Screen      0  "Screen0"
    InputDevice    "Keyboard0" "CoreKeyboard"
    InputDevice    "Mouse0" "CorePointer"
EndSection

Section "Files"
EndSection

Section "InputDevice"
    # generated from default
    Identifier     "Mouse0"
    Driver         "mouse"
    Option         "Protocol" "auto"
    Option         "Device" "/dev/psaux"
    Option         "Emulate3Buttons" "no"
    Option         "ZAxisMapping" "4 5"
EndSection

Section "InputDevice"
    # generated from default
    Identifier     "Keyboard0"
    Driver         "kbd"
EndSection

Section "Monitor"
    Identifier     "Monitor0"
    VendorName     "Unknown"
    ModelName      "Unknown"
    Option         "DPMS"
EndSection

Section "Device"
    Identifier     "intel"
    Driver         "modesetting"
    Option         "AccelMethod" "none"
    BusID          "PCI:0:2:0"
EndSection

Section "Device"
    Identifier     "Device0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
    BusID          "PCI:1:0:0"
EndSection

Section "Screen"
    Identifier     "Screen0"
    Device         "Device0"
    Monitor        "Monitor0"
    DefaultDepth    24
    SubSection     "Display"
        Depth       24
    EndSubSection
EndSection
```

According to  [this docs](https://wiki.archlinux.org/title/NVIDIA_Optimus) you need set some options to `xrandr` 

You can see the name of your output provider with the command `xrandr --listproviders`

- manually: 

```bash
xrandr --setprovideroutputsource modesetting NVIDIA-0
xrandr --auto
```

- Add to startup

```bash
# create this file /etc/lightdm/display_setup.sh and add the below lines to it
#!/bin/sh
xrandr --setprovideroutputsource modesetting NVIDIA-0
xrandr --auto

# Make the script executable
sudo chmod +x /etc/lightdm/display_setup.sh

# Now configure lightdm to run the script by editing the [SeatDefaults] section in /etc/lightdm/lightdm.conf
[SeatDefaults]
display-setup-script=/etc/lightdm/display_setup.sh
```

